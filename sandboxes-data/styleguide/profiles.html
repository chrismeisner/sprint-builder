<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Profiles ‚Äì Miles Styleguide</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Inter+Tight:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="tokens.css" />
  <link rel="stylesheet" href="base.css" />
  <link rel="stylesheet" href="typography-styles.css" />
  <link rel="stylesheet" href="profile-cards.css" />
  <link rel="stylesheet" href="sidebar-nav.css" />
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: var(--font-family-sans);
      background: var(--neutral-50);
      color: var(--neutral-900);
      -webkit-font-smoothing: antialiased;
    }

    .wrap {
      max-width: 1400px;
      margin: auto;
      padding: 32px 16px 64px;
    }

    h1 {
      margin: 0 0 8px;
      font-family: var(--font-family-sans);
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .subtitle {
      font-family: var(--font-family-sans);
      font-size: 15px;
      font-weight: 400;
      color: var(--neutral-600);
      margin: 0 0 32px;
      line-height: 1.5;
    }

    /* Global fade-in on page load */
    body {
      opacity: 0;
      animation: globalFadeIn 600ms ease forwards;
    }

    @keyframes globalFadeIn {
      to {
        opacity: 1;
      }
    }

    /* Staggered fade-in for profile cards */
    .profile-card {
      opacity: 0;
      transform: translateY(16px);
      animation: cardFadeIn 400ms ease forwards;
    }

    .profile-card:nth-child(1) { animation-delay: 100ms; }
    .profile-card:nth-child(2) { animation-delay: 200ms; }
    .profile-card:nth-child(3) { animation-delay: 300ms; }
    .profile-card:nth-child(4) { animation-delay: 400ms; }

    @keyframes cardFadeIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* =====================================================
       PERSONA VARIATION SELECTORS
    ===================================================== */

    .persona-variation-controls {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .variation-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .variation-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--neutral-500);
      min-width: 38px;
      flex-shrink: 0;
    }

    .variation-select {
      font-size: 13px;
      font-family: var(--font-family-sans);
      padding: 4px 24px 4px 8px;
      border: 1px solid var(--neutral-200);
      border-radius: 6px;
      background: var(--neutral-0);
      color: var(--neutral-700);
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' fill='none'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23999' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      min-width: 90px;
      transition: border-color 150ms ease;
    }

    .variation-select:hover {
      border-color: var(--neutral-300);
    }

    .variation-select:focus {
      outline: none;
      border-color: var(--brand-primary-400);
      box-shadow: 0 0 0 2px var(--brand-primary-100);
    }

    /* Dismiss button */
    .placeholder-note {
      position: relative;
    }

    .dismiss-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 24px;
      height: 24px;
      padding: 0;
      border: none;
      border-radius: 4px;
      background: transparent;
      color: var(--brand-primary-400);
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 150ms ease, color 150ms ease;
    }

    .dismiss-btn:hover {
      background: var(--brand-primary-100);
      color: var(--brand-primary-700);
    }

    /* Shuffle bar */
    .shuffle-bar {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 12px;
    }

    .shuffle-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-family: var(--font-family-sans);
      font-size: 12px;
      font-weight: 600;
      padding: 5px 12px;
      border: 1px solid var(--neutral-200);
      border-radius: 6px;
      background: var(--neutral-0);
      color: var(--neutral-600);
      cursor: pointer;
      transition: border-color 150ms ease, background 150ms ease;
    }

    .shuffle-btn:hover {
      border-color: var(--neutral-300);
      background: var(--neutral-50);
      color: var(--neutral-800);
    }

    .shuffle-btn:active {
      background: var(--neutral-100);
    }

    /* Download button */
    .download-avatar-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      padding: 0;
      border: 1px solid var(--neutral-200);
      border-radius: 6px;
      background: var(--neutral-0);
      color: var(--neutral-600);
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: border-color 150ms ease, background 150ms ease;
      flex-shrink: 0;
    }

    .download-avatar-btn:hover {
      border-color: var(--neutral-300);
      background: var(--neutral-50);
      color: var(--neutral-800);
    }

    .download-avatar-btn:active {
      background: var(--neutral-100);
    }

    /* Image loading state */
    .profile-avatar img {
      transition: opacity 200ms ease;
    }

    .profile-avatar img.loading {
      opacity: 0.4;
    }

    .profile-avatar-wrap {
      position: relative;
    }

    /* =====================================================
       JTBD PERSONA CARD STYLES
    ===================================================== */
    
    /* Core Job Statement */
    .jtbd-statement {
      padding: 20px 24px;
      background: linear-gradient(135deg, var(--brand-primary-50) 0%, var(--neutral-50) 100%);
      border-bottom: 1px solid var(--neutral-100);
    }

    .jtbd-label {
      display: block;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--brand-primary-600);
      margin-bottom: 8px;
    }

    .jtbd-text {
      margin: 0;
      font-size: 16px;
      font-weight: 500;
      line-height: 1.5;
      color: var(--neutral-800);
      font-style: italic;
    }

    /* Role & Relationship */
    .role-relationship-section {
      padding: 16px 24px;
      background: var(--neutral-100);
      border-bottom: 1px solid var(--neutral-200);
    }

    .role-relationship-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px 16px;
      align-items: baseline;
    }

    .role-label, .relationship-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--neutral-500);
    }

    .role-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--neutral-900);
    }

    .relationship-value {
      font-size: 13px;
      color: var(--neutral-700);
      line-height: 1.4;
    }

    /* Section Common Styles */
    .persona-section {
      padding: 16px 24px;
      border-bottom: 1px solid var(--neutral-100);
    }

    .persona-section:last-child {
      border-bottom: none;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .section-icon {
      font-size: 16px;
    }

    .section-title {
      margin: 0;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--neutral-500);
    }

    .section-subtitle {
      margin: 0;
      font-size: 11px;
      font-weight: 400;
      color: var(--neutral-400);
      margin-left: auto;
    }

    /* Trigger Moments */
    .trigger-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .trigger-list li {
      position: relative;
      padding: 6px 0 6px 20px;
      font-size: 13px;
      color: var(--neutral-700);
      line-height: 1.4;
    }

    .trigger-list li::before {
      content: '‚ö°';
      position: absolute;
      left: 0;
      font-size: 12px;
    }

    /* Must-Have Outcomes */
    .outcomes-section {
      background: var(--brand-primary-50);
    }

    .outcomes-section .section-title {
      color: var(--brand-primary-700);
    }

    .outcome-item {
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .outcome-item:last-child {
      margin-bottom: 0;
    }

    .outcome-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--brand-primary-800);
      margin-bottom: 2px;
    }

    .outcome-desc {
      margin: 0;
      font-size: 12px;
      color: var(--brand-primary-700);
      line-height: 1.4;
    }

    /* Trust & Fairness Rules */
    .trust-rules-section {
      background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
    }

    .trust-rules-section .section-title {
      color: #92400e;
    }

    .trust-rules-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .trust-rules-list li {
      position: relative;
      padding: 8px 0 8px 24px;
      font-size: 13px;
      color: #78350f;
      line-height: 1.4;
      border-bottom: 1px solid rgba(252, 211, 77, 0.3);
    }

    .trust-rules-list li:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .trust-rules-list li::before {
      content: 'üö´';
      position: absolute;
      left: 0;
      font-size: 12px;
    }

    /* Default Visibility */
    .visibility-section {
      background: linear-gradient(135deg, #ede9fe 0%, #f3e8ff 100%);
    }

    .visibility-section .section-title {
      color: #5b21b6;
    }

    .visibility-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .visibility-item {
      padding: 10px 12px;
      border-radius: 8px;
    }

    .visibility-sees {
      background: rgba(255, 255, 255, 0.6);
      border-left: 3px solid #22c55e;
    }

    .visibility-not-sees {
      background: rgba(255, 255, 255, 0.4);
      border-left: 3px solid #ef4444;
    }

    .visibility-positioning {
      background: rgba(255, 255, 255, 0.5);
      border-left: 3px solid #6d28d9;
    }

    .visibility-label {
      display: block;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 4px;
    }

    .visibility-sees .visibility-label {
      color: #16a34a;
    }

    .visibility-not-sees .visibility-label {
      color: #dc2626;
    }

    .visibility-positioning .visibility-label {
      color: #6d28d9;
    }

    .visibility-value {
      margin: 0;
      font-size: 13px;
      color: #4c1d95;
      line-height: 1.4;
    }

    /* What Success Looks Like */
    .success-section {
      background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
    }

    .success-section .section-title {
      color: #047857;
    }

    .success-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .success-list li {
      position: relative;
      padding: 8px 0 8px 24px;
      font-size: 13px;
      color: #065f46;
      line-height: 1.4;
    }

    .success-list li::before {
      content: '‚úì';
      position: absolute;
      left: 0;
      font-size: 14px;
      font-weight: 700;
      color: #10b981;
    }

    /* =====================================================
       JOURNEYS SECTION
    ===================================================== */

    .journeys-section {
      background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%);
    }

    .journeys-section .section-title {
      color: #1e40af;
    }

    .journey-link-list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .journey-link-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(59, 130, 246, 0.15);
      border-radius: 8px;
      text-decoration: none;
      color: var(--neutral-800);
      transition: all 150ms ease;
    }

    .journey-link-item:hover {
      background: rgba(255, 255, 255, 0.95);
      border-color: rgba(59, 130, 246, 0.35);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
      transform: translateY(-1px);
    }

    .journey-link-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: #dbeafe;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .journey-link-content {
      flex: 1;
      min-width: 0;
    }

    .journey-link-name {
      font-size: 14px;
      font-weight: 600;
      color: #1e40af;
      display: block;
      line-height: 1.3;
    }

    .journey-link-badge {
      display: inline-block;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 3px;
    }

    .journey-link-badge--primary {
      background: #dbeafe;
      color: #1e40af;
    }

    .journey-link-badge--secondary {
      background: #e0e7ff;
      color: #3730a3;
    }

    .journey-link-arrow {
      width: 16px;
      height: 16px;
      color: #93c5fd;
      flex-shrink: 0;
      transition: transform 150ms ease, color 150ms ease;
    }

    .journey-link-item:hover .journey-link-arrow {
      color: #3b82f6;
      transform: translateX(2px);
    }

    .journey-empty {
      font-size: 13px;
      color: #64748b;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>User Personas</h1>
    <p class="subtitle">Target user personas for Miles ‚Äî the families, parents, and teens we're designing for.</p>

    <div class="placeholder-note" id="introNote">
      <button class="dismiss-btn" id="dismissIntro" title="Dismiss">√ó</button>
      <h3>üë®‚Äçüëß The Two Sides of Miles</h3>
      <p>
        Miles serves two users with different needs: the <strong>parent</strong> seeking peace of mind without being overbearing, 
        and the <strong>teen</strong> wanting independence while proving they're responsible. Both must feel the app is fair 
        for Miles to succeed. These personas use the JTBD (Jobs To Be Done) framework to capture what matters most.
      </p>
    </div>

    <div class="shuffle-bar">
      <button id="shuffleAllBtn" class="shuffle-btn" title="Randomize all persona images">‚ü≥ Shuffle</button>
    </div>

    <div id="profilesGrid" class="profiles-grid"></div>
  </div>

  <script src="sidebar-nav.js"></script>
  <script src="personas-data.js"></script>
  <script>
    // ============================================
    // DISMISS INTRO NOTE
    // ============================================
    (function() {
      const note = document.getElementById('introNote');
      const btn = document.getElementById('dismissIntro');
      if (localStorage.getItem('profiles-intro-dismissed') === '1') {
        note.style.display = 'none';
      }
      btn.addEventListener('click', () => {
        note.style.display = 'none';
        localStorage.setItem('profiles-intro-dismissed', '1');
      });
    })();

    // ============================================
    // RENDERING LOGIC
    // Persona data is loaded from personas-data.js
    // ============================================
    const personas = typeof PERSONAS !== 'undefined' ? PERSONAS : [];

    // Journey mapping: which persona indices appear in which journeys
    const PERSONA_JOURNEYS = {
      0: [
        { name: 'First Trip Journey', url: 'user-journey-first-trip.html', badge: 'Primary', icon: 'üöó' }
      ],
      1: [
        { name: 'Teen Onboarding Journey', url: 'user-journey-teen.html', badge: 'Secondary', icon: 'üéì' }
      ]
    };

    function renderPersonas() {
      const grid = document.getElementById('profilesGrid');
      if (!grid) return;

      if (!personas.length) {
        grid.innerHTML = '<p style="color: var(--neutral-500); font-size: 14px;">No personas defined. Add them to personas-data.js</p>';
        return;
      }

      grid.innerHTML = personas.map((persona, index) => `
        <article class="profile-card" data-persona-id="${persona.id}" data-persona-index="${index}">
          <!-- HEADER: Name ‚Üí Avatar ‚Üí Selectors (stacked, centered) -->
          <div class="profile-header profile-header--stacked">
            <h2 class="profile-name">Persona ${index + 1}: ${persona.name}</h2>
            <div class="profile-avatar-wrap">
              <div class="profile-avatar profile-avatar--large">
                ${persona.avatar 
                  ? `<img src="${persona.avatar}" alt="${persona.name}" id="avatar-${index}" />`
                  : `<div class="profile-avatar-placeholder">${persona.emoji || 'üë§'}</div>`
                }
              </div>
            </div>
            <div class="persona-variation-controls">
              <select class="variation-select" id="gender-${index}" data-variation="gender" data-persona="${index}">
                <option value="male" selected>Male</option>
                <option value="female">Female</option>
              </select>
              <select class="variation-select" id="skintone-${index}" data-variation="skintone" data-persona="${index}">
                <option value="light" selected>Light</option>
                <option value="medium">Medium</option>
                <option value="dark">Dark</option>
              </select>
              <button class="download-avatar-btn" data-persona="${index}" title="Download profile image">‚Üì</button>
            </div>
          </div>

          <!-- ROLE & RELATIONSHIP -->
          <div class="role-relationship-section">
            <div class="role-relationship-grid">
              <span class="role-label">Role:</span>
              <span class="role-value">${persona.role}</span>
              <span class="relationship-label">Relationship:</span>
              <span class="relationship-value">${persona.relationship}</span>
            </div>
          </div>

          <!-- CORE JOB (JTBD) -->
          <div class="jtbd-statement">
            <span class="jtbd-label">Core Job (JTBD)</span>
            <p class="jtbd-text">${persona.coreJob}</p>
          </div>

          <div class="profile-body">
            <!-- TRIGGER MOMENTS -->
            <div class="persona-section">
              <div class="section-header">
                <span class="section-icon">‚ö°</span>
                <h3 class="section-title">Trigger Moments</h3>
                <span class="section-subtitle">why they open Miles</span>
              </div>
              <ul class="trigger-list">
                ${persona.triggerMoments.map(item => `<li>${item}</li>`).join('')}
              </ul>
            </div>

            <!-- MUST-HAVE OUTCOMES -->
            <div class="persona-section outcomes-section">
              <div class="section-header">
                <span class="section-icon">üéØ</span>
                <h3 class="section-title">Must-Have Outcomes</h3>
                <span class="section-subtitle">non-negotiables</span>
              </div>
              <div class="outcomes-list">
                ${persona.mustHaveOutcomes.map(item => `
                  <div class="outcome-item">
                    <span class="outcome-label">${item.label}:</span>
                    <p class="outcome-desc">${item.description}</p>
                  </div>
                `).join('')}
              </div>
            </div>

            <!-- TRUST & FAIRNESS RULES -->
            <div class="persona-section trust-rules-section">
              <div class="section-header">
                <span class="section-icon">ü§ù</span>
                <h3 class="section-title">Trust & Fairness Rules</h3>
                <span class="section-subtitle">what can't be violated</span>
              </div>
              <ul class="trust-rules-list">
                ${persona.trustFairnessRules.map(item => `<li>${item}</li>`).join('')}
              </ul>
            </div>

            <!-- DEFAULT VISIBILITY MODEL -->
            <div class="persona-section visibility-section">
              <div class="section-header">
                <span class="section-icon">üëÅÔ∏è</span>
                <h3 class="section-title">Default Visibility Model</h3>
                <span class="section-subtitle">how Miles should behave</span>
              </div>
              <div class="visibility-grid">
                ${persona.defaultVisibility.sees ? `
                  <div class="visibility-item visibility-sees">
                    <span class="visibility-label">${persona.id === 'driving-parent' ? 'Parent sees' : 'Teen sees'}:</span>
                    <p class="visibility-value">${persona.defaultVisibility.sees}</p>
                  </div>
                ` : ''}
                ${persona.defaultVisibility.doesNotSee ? `
                  <div class="visibility-item visibility-not-sees">
                    <span class="visibility-label">${persona.id === 'driving-parent' ? 'Parent does NOT see' : 'Teen does NOT see'}:</span>
                    <p class="visibility-value">${persona.defaultVisibility.doesNotSee}</p>
                  </div>
                ` : ''}
                ${persona.defaultVisibility.productPositioning ? `
                  <div class="visibility-item visibility-positioning">
                    <span class="visibility-label">Product Positioning:</span>
                    <p class="visibility-value">${persona.defaultVisibility.productPositioning}</p>
                  </div>
                ` : ''}
              </div>
            </div>

            <!-- WHAT SUCCESS LOOKS LIKE -->
            <div class="persona-section success-section">
              <div class="section-header">
                <span class="section-icon">‚ú®</span>
                <h3 class="section-title">What Success Looks Like</h3>
              </div>
              <ul class="success-list">
                ${persona.successLooksLike.map(item => `<li>${item}</li>`).join('')}
              </ul>
            </div>

            <!-- JOURNEYS THIS PERSONA IS IN -->
            <div class="persona-section journeys-section">
              <div class="section-header">
                <span class="section-icon">üó∫Ô∏è</span>
                <h3 class="section-title">Journeys This Persona Is In</h3>
              </div>
              ${(PERSONA_JOURNEYS[index] && PERSONA_JOURNEYS[index].length)
                ? `<div class="journey-link-list">
                    ${PERSONA_JOURNEYS[index].map(journey => `
                      <a href="${journey.url}" class="journey-link-item">
                        <div class="journey-link-icon">${journey.icon}</div>
                        <div class="journey-link-content">
                          <span class="journey-link-name">${journey.name}</span>
                          <span class="journey-link-badge journey-link-badge--${journey.badge.toLowerCase()}">${journey.badge}</span>
                        </div>
                        <svg class="journey-link-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                      </a>
                    `).join('')}
                  </div>`
                : `<p class="journey-empty">No journeys mapped yet.</p>`
              }
            </div>
          </div>
        </article>
      `).join('');
    }

    // Initialize
    renderPersonas();

    // ============================================
    // PERSONA VARIATION SELECTOR LOGIC
    // ============================================

    // Track current selections per persona
    const personaSelections = personas.map(() => ({
      gender: 'male',
      skintone: 'light'
    }));

    // Image existence cache to avoid repeated 404s
    const imageCache = {};

    function buildVariantPath(persona, gender, skintone) {
      if (!persona.avatarBase) return persona.avatar;
      return `${persona.avatarBase}-${gender}-${skintone}.jpg`;
    }

    function checkImageExists(url) {
      return new Promise((resolve) => {
        if (imageCache[url] !== undefined) {
          resolve(imageCache[url]);
          return;
        }
        const img = new Image();
        img.onload = () => { imageCache[url] = true; resolve(true); };
        img.onerror = () => { imageCache[url] = false; resolve(false); };
        img.src = url;
      });
    }

    async function updateAvatar(personaIndex) {
      const persona = personas[personaIndex];
      const sel = personaSelections[personaIndex];
      const imgEl = document.getElementById(`avatar-${personaIndex}`);
      if (!imgEl) return;

      // Build variant path
      const variantPath = buildVariantPath(persona, sel.gender, sel.skintone);

      // Add loading state
      imgEl.classList.add('loading');

      // Try variant, fall back to default
      const exists = await checkImageExists(variantPath);
      if (exists) {
        imgEl.src = variantPath;
      } else {
        imgEl.src = persona.avatar; // fallback to default
      }

      imgEl.classList.remove('loading');
    }

    // Event delegation for variation dropdowns
    document.addEventListener('change', (e) => {
      const select = e.target.closest('.variation-select');
      if (!select) return;

      const personaIdx = parseInt(select.dataset.persona, 10);
      const variationType = select.dataset.variation;
      const value = select.value;

      personaSelections[personaIdx][variationType] = value;
      updateAvatar(personaIdx);
    });

    // Download button handler
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.download-avatar-btn');
      if (!btn) return;

      const personaIdx = parseInt(btn.dataset.persona, 10);
      const imgEl = document.getElementById(`avatar-${personaIdx}`);
      if (!imgEl || !imgEl.src) return;

      const a = document.createElement('a');
      a.href = imgEl.src;
      // Extract the filename from the src path
      const parts = imgEl.src.split('/');
      a.download = parts[parts.length - 1].split('?')[0]; // strip any query params
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    // Shuffle button handler ‚Äî randomize gender + skintone for all personas
    const genderOptions = ['male', 'female'];
    const skintoneOptions = ['light', 'medium', 'dark'];

    function pickRandom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    document.getElementById('shuffleAllBtn').addEventListener('click', () => {
      personas.forEach((_, idx) => {
        const gender = pickRandom(genderOptions);
        const skintone = pickRandom(skintoneOptions);

        personaSelections[idx].gender = gender;
        personaSelections[idx].skintone = skintone;

        // Sync the dropdowns
        document.getElementById(`gender-${idx}`).value = gender;
        document.getElementById(`skintone-${idx}`).value = skintone;

        updateAvatar(idx);
      });
    });

    // Auto-shuffle on page load
    document.getElementById('shuffleAllBtn').click();
  </script>
</body>
</html>
